---
title: "Retrospecitve_markdown"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:



```{r Functions for state-space stock-recruitment models, cache=TRUE, echo=FALSE}

# source functions
source("Yuk_harv_div_functions.R")

```



```{r libraries to load, cache=TRUE, echo=FALSE, message=FALSE}

# source libraries
source("retrospective_load.R")

```



```{r create output file paths, echo=FALSE}

# create path for exporting figures
figure_path <- "figures"



# obtain time-stamp (used for time-stamping outputs)
system_time <- format(Sys.time(),"%Y-%m-%d")

```



```{r load Scenario A: Model Based Run Reconstruction (Landmark), echo=FALSE,eval=TRUE}

# NOTE:  Only load one Run Reconstruction Scenario at a time to progress through the downstream analyses and figures
# Use the 'eval' option to turn on/off the Scenarios that are of interest for a particular run

ScenA_RR <- readRDS("outputs/Yukon_data_for_BS_ScenA.RR_July312019.RDS")

```


```{r load Scenario B: Data Based Run Reconstruction, echo=FALSE,eval=FALSE}

# NOTE:  Only load one Run Reconstruction Scenario at a time to progress through the downstream analyses and figures
# Use the 'eval' option to turn on/off the Scenarios that are of interest for a particular run

ScenB_RR <- readRDS("outputs/Yukon_data_for_BS_ScenB.RR_July312019.RDS")

```






```{r dataframe for plotting different RRs against each other,echo=FALSE}
# Restore the different RR spawner data objects
ScenA_spwn <- readRDS(file = "outputs/ScenarioA_RR_spawners.RDS")
ScenB_spwn <- readRDS(file = "outputs/ScenarioB_RR_spawners.RDS")

year <- rep(c(1985:2016),8)
pop <- rep(c("Carmacks","LowerMainstem","MiddleMainstem","Pelly",
             "Stewart","Teslin","UpperLakesAndMainstem","WhiteDonjek"),32)

df <- data.frame(year,pop,ScenA_spwn, ScenB_spwn)

```


```{r plot Figure S1 - ScenarioA and ScenarioB spwner abundances by substock,echo=FALSE,fig.width=6,fig.height=6}


ggplot(df, aes(x=ScenA_spwn/1000, y=ScenB_spwn/1000,color=as.factor(year))) +
  geom_point(size=2.5) +
  geom_abline(slope=1, intercept=0, lty="dotted") +
  xlab("Model-based spawners (000s)") +
  ylab("Data-based spawners (000s)") +
  labs(colour= "Year") +
  facet_wrap(~pop,ncol=3,scales="free") +
  theme_bw() +
  theme(#legend.position = "none",
        aspect.ratio = 1)
# ggsave(file.path(figure_path, paste("Figure_S1.spawner.compare_",system_time,".pdf", sep="")),height = 5, width = 7)

```



```{r Figure 3, echo=FALSE}
# Figure 3. Daily estimates of border passage and scale sampling ####


# read in border counts (fish wheel and sonar)
border_counts <- read.delim("data/input_bordercounts2.txt")



# modify border counts data frame
# sum border counts by year
# View(border_counts %>%
#       na.omit() %>%
#       group_by(year) %>%
#       summarise(sum = sum(count)))


# add column of counts per year to new dataframe bc2
bc2 <- border_counts %>% 
  mutate(sum = case_when(year == "1985" ~ 1321,
                         year == "1986" ~ 1998,
                         year == "1987" ~ 938,
                         year == "1988" ~ 976,
                         year == "1989" ~ 1065,
                         year == "1990" ~ 1361,
                         year == "1991" ~ 1726,
                         year == "1992" ~ 1889,
                         year == "1993" ~ 1241,
                         year == "1994" ~ 1290,
                         year == "1995" ~ 2215,
                         year == "1996" ~ 1749,
                         year == "1997" ~ 2221,
                         year == "1998" ~ 1080,
                         year == "1999" ~ 914,
                         year == "2000" ~ 1494,
                         year == "2001" ~ 3986,
                         year == "2002" ~ 1065,
                         year == "2003" ~ 1276,
                         year == "2004" ~ 1361,
                         year == "2005" ~ 81529,
                         year == "2006" ~ 73691,
                         year == "2007" ~ 41697,
                         year == "2008" ~ 38097,
                         year == "2009" ~ 69963,
                         year == "2010" ~ 35074,
                         year == "2011" ~ 51271,
                         year == "2012" ~ 34747,
                         year == "2013" ~ 30725,
                         year == "2014" ~ 63462,
                         year == "2015" ~ 84015,
                         year == "2016" ~ 72329))


# change year and julian to different classes
bc2$year <- as.factor(bc2$year)
bc2$julian <- as.double(bc2$julian)


# create adjusted julian column to account for mismatch in 
bc2_b <- bc2 %>%
  mutate(revised_julian = case_when(count_type == "sonar" ~ julian,
                                    count_type == "fish_wheel" ~ julian + 1))


# create proportion of total run count per julian day count
bc2_b$prop <- NA
bc2_b$prop <- bc2$count/bc2$sum




# read in Genetic Stock ID data from fish collected at border 
# ("probability" is the probability individual fish originated from stock X)
GSI <- read.csv("data/input_Yukon_GSI_82_05_longform2.csv")

# modify individual GSI assignment dataframe
GSI.region <- subset(GSI, prob > 0.4)

# create data frame of number of samples per day and year 
GSI.counts <- plyr::ddply(GSI.region,c("year","julian_date"),function(x){
  count <- dim(x)[1]
  data.frame(count)
})

# add column of gsi counts per year to new dataframe: only keep samples with prob > 0.5
gsi2 <- GSI.counts %>% 
  dplyr::mutate(year_count = case_when(year == "1982" ~ 124,
                                       year == "1983" ~ 141,
                                       year == "1985" ~ 149,
                                       year == "1986" ~ 149,
                                       year == "1987" ~ 148,
                                       year == "1991" ~ 147,
                                       year == "1992" ~ 149,
                                       year == "1993" ~ 149,
                                       year == "1994" ~ 149,
                                       year == "1995" ~ 149,
                                       year == "1996" ~ 144,
                                       year == "1997" ~ 150,
                                       year == "1998" ~ 0,
                                       year == "1999" ~ 147,
                                       year == "2000" ~ 148,
                                       year == "2001" ~ 149,
                                       year == "2002" ~ 150,
                                       year == "2003" ~ 148,
                                       year == "2004" ~ 131,
                                       year == "2005" ~ 142,
                                       year == "2006" ~ 150,
                                       year == "2007" ~ 149,
                                       year == "2008" ~ 452,
                                       year == "2009" ~ 646,
                                       year == "2010" ~ 467,
                                       year == "2011" ~ 497,
                                       year == "2012" ~ 344,
                                       year == "2013" ~ 290,
                                       year == "2014" ~ 708,
                                       year == "2015" ~ 1026,
                                       year == "2016" ~ 728))

# create proportion of total run count per julian day count
gsi2$prop <- NA
gsi2$prop <- gsi2$count/gsi2$year_count


# create sample size number dataframe for geom_text in plot
dat_text <- data.frame(label = c("124", "141", "149","149", "148", "147",
                                 "149", "149", "149","149", "144", "150", "147", "148",
                                 "149", "150", "148","131", "142","150","149","452","646",
                                 "467","497","344","290","708","1026","728"),
                       year = c(1982,1983,1985,1986,1987,1991,
                                1992,1993,1994,1995,1996,1997, 1999,2000,
                                2001,2002,2003,2004,2005,2006, 2007,2008,2009,
                                2010,2011,2012,2013,2014,2015,2016))

# Run size distribution and GSI size and distribution, memo Fig 2
n <- c(1982:1987,1991:1997,1999:2016)
bc3 <- bc2_b %>%
  filter(year %in% n)

gsi3 <- gsi2 %>%
  filter(year %in% n)


```


```{r  Figure 3 plot figure border counts and gsi sample size,echo=FALSE,fig.dim=c(7,7) }


ggplot(bc3, aes(x=revised_julian, y = prop)) +
  geom_bar(stat = "identity") +
  geom_bar(data = gsi3 %>% filter(julian_date < 1000), aes(x=julian_date, y=prop), 
           fill="red", alpha=0.5, stat = "identity") +
  scale_x_continuous(limits=c(150,300), breaks = c(150,175,200,225,250,275,300)) +
  xlab("Julian day") +
  ylab("Run size and GSI sample size") +
  facet_wrap(~year, scales = "free_y") +
  theme_bw() +
  theme(axis.text.x = element_text(size=9, angle = 45, hjust = 1)) +
  theme(strip.text = element_text(size=10)) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  geom_text(data = dat_text, mapping = aes(x = -Inf, y = -Inf, label = label),
            hjust = -0.3, vjust = -3, size=2.5)
# ggsave(file.path(figure_path, paste("Figure_3.border.count_",system_time,".pdf", sep="")),height = 5, width = 7)
```











```{r  Prep Population border passage over time for ScenarioA Run Reconstruction, echo=FALSE}
load("./data/runSize.Rdata")


ScenA_data <- runSize %>%
  group_by(year) %>%
  mutate(run = sum(MLE)) %>%
  ungroup() %>%
  mutate(proportion = MLE/run,
         se_prop = SE/MLE,
         lwr_1 = proportion - se_prop,
         upr_1 = proportion + se_prop,
         lwr = case_when(lwr_1 < 0 ~ 0,
                         lwr_1 > 0 ~ lwr_1),
         upr = case_when(upr_1 < 1 ~ upr_1,
                         upr_1 > 1 ~ 1)) %>%
  select(-lwr_1, -upr_1) %>%
  distinct() %>%
  as.data.frame()



# stock compositions for Scenario B data-based GSI proportions
age_and_harvest <- read.csv("data/age_and_harvest_data.csv")

StandDev_df <- age_harv_modified %>%
  select(year, Carmacks.sd:WhiteDonjek.sd) %>%
  mutate(value_class = "sd") %>%
  select(year, value_class, Carmacks.sd:WhiteDonjek.sd) %>%
  gather(key=population, value = sd, Carmacks.sd:WhiteDonjek.sd) %>%
  mutate(population = str_remove_all(population, ".sd")) %>%
  select(-value_class)

ScenB_data1 <- age_and_harvest %>%
  filter(year != 2017) %>%
  rename(Carmacks = Yukon.Carmacks,
         LowerMainstem = Yukon.Lower.Canadian,
         MiddleMainstem = Yukon.mainstem,
         Pelly = Yukon.Pelly,
         Stewart = Yukon.Stewart,
         Teslin = Yukon.Teslin,
         UpperLakesandMainstem = Yukon.upper,
         WhiteDonjek = Yukon.White.Donjek) %>%
  gather(key=population, value = proportion, UpperLakesandMainstem:WhiteDonjek) %>%
  select(year, run, population, proportion) %>%
  mutate(pop_run = round(run*proportion))


ScenB_data1 <- full_join(StandDev_df, ScenB_data1) %>%
  mutate(run_sd = round(sd*run)) %>%
  mutate(lwr_1 = proportion - sd,
         upr_1 = proportion + sd,
         lwr = case_when(lwr_1 < 0 ~ 0,
                         lwr_1 > 0 ~ lwr_1),
         upr = case_when(upr_1 < 100 ~ upr_1,
                         upr_1 > 100 ~ 100)) %>%
  select(-lwr_1, -upr_1) %>%
  na.omit() %>%
  distinct()


# create infill data frame
year <- rep(c(1984, 1988:1990, 1998), times=8)
population <- rep(c("Carmacks","LowerMainstem","MiddleMainstem","Pelly","Stewart","Teslin","UpperLakesandMainstem","WhiteDonjek" ), each=5)
sd <- rep(c(0),each=40)
run <- rep(c(0),each=40)
proportion <- rep(c(0),each=40)
pop_run <- rep(c(0),each=40)
run_sd <- rep(c(0),each=40)
lwr <- rep(c(0),each=40)
upr <- rep(c(0),each=40)


infill_df <- data.frame(year, population, sd, run, proportion, pop_run, run_sd, lwr, upr)


# join dataframes for complete by year Scenario B data
ScenB_data <- full_join(ScenB_data1, infill_df) %>%
  arrange(year)

```


```{r Figure 7 - border passage by population over time, echo=FALSE, fig.dim=c(5,7)}
# Plot ScenarioA population run proportions
ggplot(ScenA_data, aes(x = as.factor(year), y = proportion*100)) + 
  geom_bar(stat = "identity", colour = "black", fill="light grey", width= 1) +
  geom_errorbar(data=ScenA_data, aes(ymin=lwr*100, ymax=upr*100), width=0.1) +
  geom_vline(xintercept = 2008, lty = "dotted") +
  xlab("Year") +
  ylab("Population run size (%)") +
  #scale_y_continuous(limits = c(0,100)) +
  scale_x_discrete(breaks = c("1984","1988","1992","1996","2000","2004","2008","2012","2016")) +
  theme_bw() +
  facet_wrap(~stock, ncol=3, scales = "free_y") +
  theme(strip.text = element_text(size=10)) +
  theme(axis.text.x = element_text(angle=45, hjust=1)) +
  theme(axis.text = element_text(size=10)) +
  theme(axis.title = element_text(size=10))
#ggsave(file.path(figure_path, paste("Figure_7.popn.passage_ScenA_",system_time,".pdf", sep="")),height = 5, width = 7)


# Plot ScenarioB population run proportions
ggplot(ScenB_data, aes(x = as.factor(year), y = proportion*100)) + 
  geom_bar(stat = "identity", fill="light grey",colour = "black", width=1) +
  geom_errorbar(data=ScenB_data, aes(x= as.factor(year), ymin= lwr*100, ymax=upr*100, width=.1)) +
  #geom_vline(xintercept = "2008", lty = "dotted") +
  xlab("Year") +
  ylab("Population run size (%)") +
  scale_x_discrete(breaks = c("1984","1988","1992","1996","2000","2004","2008","2012","2016")) +
  theme_bw() +
  facet_wrap(~population, ncol=3, scales = "free_y") +
  theme(strip.text = element_text(size=10)) +
  theme(axis.text.x = element_text(angle=45, hjust=1)) +
  theme(axis.text = element_text(size=10)) +
  theme(axis.title = element_text(size=10))
#ggsave(file.path(figure_path, paste("Figure_7.popn.passage_ScenB_",system_time,".pdf", sep="")),height = 5, width = 7)

```




```{r Load Posterior files for Scenario A and Scenario B, echo=FALSE}

# load the 3 different parts of the Scenario A posterior file
Scen_A_post_1 <- read.csv("data/Posterior_Samples_A_part1.csv")
Scen_A_post_2 <- read.csv("data/Posterior_Samples_A_part2.csv")
Scen_A_post_3 <- read.csv("data/Posterior_Samples_A_part3.csv")

# bind the the parts into single dataframe
ScenarioA_posteriors <- cbind(Scen_A_post_1, Scen_A_post_2, Scen_A_post_3)



# load the 3 different parts of the Scenario B posterior file
Scen_B_post_1 <- read.csv("data/Posterior_Samples_B_part1.csv")
Scen_B_post_2 <- read.csv("data/Posterior_Samples_B_part2.csv")
Scen_B_post_3 <- read.csv("data/Posterior_Samples_B_part3.csv")

# bind the the parts into single dataframe
ScenarioB_posteriors <- cbind(Scen_B_post_1, Scen_B_post_2, Scen_B_post_3)


```




```{r productivity dataframe Scenario A for Figure 10, echo=FALSE}


# alpha dataframe
year <- rep(c(1982:2016),each=24)

alpha_A <- ScenarioA_posteriors %>%
  select(1:8) %>%
  gather(key = alpha, value = alpha_value, alpha_1:alpha_8) %>%
  mutate(population = rep(c("Lower Mainstem", "Stewart", "Pelly","White-Donjek","Middle Mainstem", "Carmacks",
                          "Upper Lakes and Mainstem", "Teslin"),each=10000)) %>%
  group_by(population) %>%
  summarise(alpha = list(enframe(quantile(alpha_value, probs=c(0.2,0.5,0.8))))) %>%
  unnest() %>%
  ungroup() %>%
  mutate(log_alpha = log(value)) %>%
  slice(rep(row_number(),35)) %>%
  mutate(year = year) %>%
  rename(alpha_value = value) %>%
  select(population, name, year, log_alpha) %>%
  spread(key = name, value = log_alpha) %>%
  rename(alpha_lwr = "20%",
         alpha_med = "50%",
         alpha_upr = "80%") %>%
  as.data.frame()
  


# residuals dataframe
year <- rep(c(1982:2016),each=10000)

resid_A <- ScenarioA_posteriors %>%
  select(634:913) %>%
  gather(key = resid, value = resid_value, log_resid_1_1:log_resid_35_8) %>%
  mutate(year = rep(year, times=8),
         population = rep(c("Lower Mainstem", "Stewart", "Pelly","White-Donjek","Middle Mainstem", "Carmacks",
                          "Upper Lakes and Mainstem", "Teslin"),each=350000)) %>%
  group_by(population, year) %>%
  summarise(resid = list(enframe(quantile(resid_value, probs=c(0.2,0.5,0.8))))) %>%
  unnest() %>%
  ungroup() %>%
  rename(log_resid = value) %>%
  select(population, name, year, log_resid) %>%
  spread(key = name, value = log_resid) %>%
  rename(resid_lwr = "20%",
         resid_med = "50%",
         resid_upr = "80%") %>%
  as.data.frame()
  
alpha_resid_df_A <- full_join(alpha_A,resid_A)


# View(alpha_resid_df_A)

```


```{r productivity dataframe Scenario B for Figure 10, echo=FALSE}


# alpha dataframe
year <- rep(c(1982:2016),each=24)

alpha_B <- ScenarioB_posteriors %>%
  select(1:8) %>%
  gather(key = alpha, value = alpha_value, alpha_1:alpha_8) %>%
  mutate(population = rep(c("Lower Mainstem", "Stewart", "Pelly","White-Donjek","Middle Mainstem", "Carmacks",
                          "Upper Lakes and Mainstem", "Teslin"),each=10000)) %>%
  group_by(population) %>%
  summarise(alpha = list(enframe(quantile(alpha_value, probs=c(0.2,0.5,0.8))))) %>%
  unnest() %>%
  ungroup() %>%
  mutate(log_alpha = log(value)) %>%
  slice(rep(row_number(),35)) %>%
  mutate(year = year) %>%
  rename(alpha_value = value) %>%
  select(population, name, year, log_alpha) %>%
  spread(key = name, value = log_alpha) %>%
  rename(alpha_lwr = "20%",
         alpha_med = "50%",
         alpha_upr = "80%") %>%
  as.data.frame()
  


# residuals dataframe
year <- rep(c(1982:2016),each=10000)

resid_B <- ScenarioB_posteriors %>%
  select(634:913) %>%
  gather(key = resid, value = resid_value, log_resid_1_1:log_resid_35_8) %>%
  mutate(year = rep(year, times=8),
         population = rep(c("Lower Mainstem", "Stewart", "Pelly","White-Donjek","Middle Mainstem", "Carmacks",
                          "Upper Lakes and Mainstem", "Teslin"),each=350000)) %>%
  group_by(population, year) %>%
  summarise(resid = list(enframe(quantile(resid_value, probs=c(0.2,0.5,0.8))))) %>%
  unnest() %>%
  ungroup() %>%
  rename(log_resid = value) %>%
  select(population, name, year, log_resid) %>%
  spread(key = name, value = log_resid) %>%
  rename(resid_lwr = "20%",
         resid_med = "50%",
         resid_upr = "80%") %>%
  as.data.frame()
  
alpha_resid_df_B <- full_join(alpha_B,resid_B)


# View(alpha_resid_df_B)

```




```{r Smsy dataframe,echo=FALSE}
Smsy_A <- ScenarioA_posteriors[,25:32]  %>%
  sample_n(1000, replace=TRUE) %>%
  gather(key = Smsy, value = value, Smsy_1:Smsy_8) %>%
  mutate(substock = rep(c("Lower Mainstem", "Stewart", "Pelly","White-Donjek","Middle Mainstem", "Carmacks",
                          "Upper Lakes and Mainstem", "Teslin"),each=1000))

Smsy_B <- ScenarioB_posteriors[,25:32]  %>%
  sample_n(1000, replace=TRUE) %>%
  gather(key = Smsy, value = value, Smsy_1:Smsy_8) %>%
  mutate(substock = rep(c("Lower Mainstem", "Stewart", "Pelly","White-Donjek","Middle Mainstem", "Carmacks",
                          "Upper Lakes and Mainstem", "Teslin"),each=1000))

```




```{r alpha and beta posteriors ScenarioA for Figure 8, echo=FALSE}
# alpha and beta posteriors
alpha.beta_A <- ScenarioA_posteriors %>%
  as.data.frame() %>%
  select(1:16)
  
pop <- c("Lower Mainstem", "Stewart", "Pelly", "White-Donjek", "Middle Mainstem", "Carmacks", "Upper Lakes and Mainstem", "Teslin")

# get percentiles
alpha_summ <- rbind(quantile(ScenarioA_posteriors$alpha_1, c(0.05,0.5,0.95)),
quantile(ScenarioA_posteriors$alpha_2, c(0.05,0.5,0.95)),
quantile(ScenarioA_posteriors$alpha_3, c(0.05,0.5,0.95)),
quantile(ScenarioA_posteriors$alpha_4, c(0.05,0.5,0.95)),
quantile(ScenarioA_posteriors$alpha_5, c(0.05,0.5,0.95)),
quantile(ScenarioA_posteriors$alpha_6, c(0.05,0.5,0.95)),
quantile(ScenarioA_posteriors$alpha_7, c(0.05,0.5,0.95)),
quantile(ScenarioA_posteriors$alpha_8, c(0.05,0.5,0.95)))

alpha_summary_A <- as.data.frame(cbind(pop, alpha_summ)) %>%
  rename(alpha_low = "5%",
         alpha_med = "50%",
         alpha_upr = "95%")

alpha_summary_A$alpha_low <- as.numeric(as.character(alpha_summary_A$alpha_low))
alpha_summary_A$alpha_med <- as.numeric(as.character(alpha_summary_A$alpha_med))
alpha_summary_A$alpha_upr <- as.numeric(as.character(alpha_summary_A$alpha_upr))

# create equilibrium values, = log(alpha)/beta
equil_product_A <- ScenarioA_posteriors[,1:16] %>%
  gather(key = alpha_pop, value = alpha_value, alpha_1:alpha_8) %>%
  gather(key = beta_pop, value = beta_value, beta_1:beta_8) %>%
  mutate(equilibrium = log(alpha_value)/beta_value,
         population = substr(beta_pop, 6,6))
 

equil_product_A_perc <- equil_product_A %>%
  group_by(population) %>%
  summarise(equil_lwr = quantile(equilibrium, probs = 0.05),
            equil_med = quantile(equilibrium, probs = 0.5),
            equil_upr = quantile(equilibrium, probs = 0.95)) %>%
  ungroup() %>%
  mutate(region = pop) %>%
  as.data.frame()

equil_alpha_percentileA <- cbind(equil_product_A_perc,alpha_summary_A) %>%
  select(-population, -region)

```



```{r alpha and beta posteriors ScenarioB for Figure 8, echo=FALSE}
# alpha and beta posteriors
alpha.beta_B <- ScenarioB_posteriors %>%
  as.data.frame() %>%
  select(1:16)
  
pop <- c("Lower Mainstem", "Stewart", "Pelly", "White-Donjek", "Middle Mainstem", "Carmacks", "Upper Lakes and Mainstem", "Teslin")

# get percentiles
alpha_summ <- rbind(quantile(ScenarioB_posteriors$alpha_1, c(0.05,0.5,0.95)),
quantile(ScenarioB_posteriors$alpha_2, c(0.05,0.5,0.95)),
quantile(ScenarioB_posteriors$alpha_3, c(0.05,0.5,0.95)),
quantile(ScenarioB_posteriors$alpha_4, c(0.05,0.5,0.95)),
quantile(ScenarioB_posteriors$alpha_5, c(0.05,0.5,0.95)),
quantile(ScenarioB_posteriors$alpha_6, c(0.05,0.5,0.95)),
quantile(ScenarioB_posteriors$alpha_7, c(0.05,0.5,0.95)),
quantile(ScenarioB_posteriors$alpha_8, c(0.05,0.5,0.95)))

alpha_summary_B <- as.data.frame(cbind(pop, alpha_summ)) %>%
  rename(alpha_low = "5%",
         alpha_med = "50%",
         alpha_upr = "95%")

alpha_summary_B$alpha_low <- as.numeric(as.character(alpha_summary_B$alpha_low))
alpha_summary_B$alpha_med <- as.numeric(as.character(alpha_summary_B$alpha_med))
alpha_summary_B$alpha_upr <- as.numeric(as.character(alpha_summary_B$alpha_upr))

# create equilibrium values, = log(alpha)/beta
equil_product_B <- ScenarioB_posteriors[,1:16] %>%
  gather(key = alpha_pop, value = alpha_value, alpha_1:alpha_8) %>%
  gather(key = beta_pop, value = beta_value, beta_1:beta_8) %>%
  mutate(equilibrium = log(alpha_value)/beta_value,
         population = substr(beta_pop, 6,6))
 

equil_product_B_perc <- equil_product_B %>%
  group_by(population) %>%
  summarise(equil_lwr = quantile(equilibrium, probs = 0.05),
            equil_med = quantile(equilibrium, probs = 0.5),
            equil_upr = quantile(equilibrium, probs = 0.95)) %>%
  ungroup() %>%
  mutate(region = pop) %>%
  as.data.frame()

equil_alpha_percentileB <- cbind(equil_product_B_perc,alpha_summary_B) %>%
  select(-population, -region)



```


```{r Figure 8 ScenA and ScenB productivity vs. equilibrium size, echo=FALSE, fig.dim=c(6,6)}

# dataframe used is equil_alpha_percentileA
# head(equil_alpha_percentileA)


# Scenario A
ggplot(data = equil_alpha_percentileA, aes(x = equil_med/1000, y = alpha_med, fill=pop)) +
  geom_errorbar(data=equil_alpha_percentileA, mapping=aes(x=equil_med/1000, ymin=alpha_low, ymax=alpha_upr), color = "gray50") +
  geom_errorbarh(data=equil_alpha_percentileA, mapping=aes(x=alpha_med, xmin=equil_lwr/1000, xmax=equil_upr/1000), color = "gray50") +
  geom_point(size=4, pch=21, colour="black") +
  xlab("Equilibrium size (000s)") +
  ylab("Intrinsic productivity") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) +
  coord_cartesian(xlim = c(0, 50), ylim = c(0,40)) +
  scale_y_continuous(breaks = c(0,10,20,30,40)) +
  theme_classic() +
  theme(axis.title = element_text(size=12)) +
  theme(axis.text = element_text(size=12)) +
  theme(legend.title=element_blank())
# ggsave(file.path(figure_path, paste("Figure_8.ScenA.product.equilibrium_",system_time,".pdf", sep="")),height = 5, width = 7)




# Scenario B
ggplot(data = equil_alpha_percentileB, aes(x = equil_med/1000, y = alpha_med, fill=pop)) +
  geom_errorbar(data=equil_alpha_percentileB, mapping=aes(x=equil_med/1000, ymin=alpha_low, ymax=alpha_upr), color = "gray50") +
  geom_errorbarh(data=equil_alpha_percentileB, mapping=aes(x=alpha_med, xmin=equil_lwr/1000, xmax=equil_upr/1000), color = "gray50") +
  geom_point(size=4, pch=21, colour="black") +
  xlab("Equilibrium size (000s)") +
  ylab("Intrinsic productivity") +
  scale_fill_viridis(option = "viridis", discrete = TRUE) +
  coord_cartesian(xlim = c(0, 50), ylim = c(0,40)) +
  scale_y_continuous(breaks = c(0,10,20,30,40)) +
  theme_classic() +
  theme(axis.title = element_text(size=12)) +
  theme(axis.text = element_text(size=12)) +
  theme(legend.title=element_blank())
# ggsave(file.path(figure_path, paste("Figure_8.ScenB.product.equilibrium_",system_time,".pdf", sep="")),height = 5, width = 7)

```





```{r recruits and spawners dataframe ScenarioA, echo=FALSE}

pop <- c("Lower Mainstem", "Stewart", "Pelly", "White-Donjek", "Middle Mainstem", "Carmacks", "Upper Lakes and Mainstem", "Teslin")

# ScenarioA_posteriors
Recruits_ScenA <- ScenarioA_posteriors[,354:633]
Spawners_ScenA <- ScenarioA_posteriors[,98:353]


R_50 <- stack(lapply(Recruits_ScenA, quantile, prob = 0.5, names = FALSE)) %>%
  mutate(year = rep(c(1:35),times=8),
         population = rep(pop, each = 35),
         param = "recruits",
         percentile = "median")
R_20 <- stack(lapply(Recruits_ScenA, quantile, prob = 0.2, names = FALSE)) %>%
  mutate(year = rep(c(1:35),times=8),
         population = rep(pop, each = 35),
         param = "recruits",
         percentile = "lower")
R_80 <- stack(lapply(Recruits_ScenA, quantile, prob = 0.8, names = FALSE)) %>%
  mutate(year = rep(c(1:35),times=8),
         population = rep(pop, each = 35),
         param = "recruits",
         percentile = "upper")

Recruits_ScenA_df <- rbind(R_50, R_20, R_80) %>%
  mutate(adj_year = as.numeric(as.character(year)) - 7) %>%
  filter(adj_year > 0) %>%
  select(4,3,7,6,5,1) %>%
  spread(key = percentile, value = values) %>%
  rename(Rec_low = lower,
         Rec_med = median,
         Rec_upp = upper) %>%
  select(-param)


S_50 <- stack(lapply(Spawners_ScenA, quantile, prob = 0.5, names = FALSE)) %>%
  mutate(year = rep(c(1:32),times=8),
         population = rep(pop, each = 32),
         param = "spawners",
         percentile = "median")
S_20 <- stack(lapply(Spawners_ScenA, quantile, prob = 0.2, names = FALSE)) %>%
  mutate(year = rep(c(1:32),times=8),
         population = rep(pop, each = 32),
         param = "spawners",
         percentile = "lower")
S_80 <- stack(lapply(Spawners_ScenA, quantile, prob = 0.8, names = FALSE)) %>%
  mutate(year = rep(c(1:32),times=8),
         population = rep(pop, each = 32),
         param = "spawners",
         percentile = "upper")

Spawners_ScenA_df <- rbind(S_50, S_20, S_80) %>%
  mutate(adj_year = as.numeric(as.character(year))) %>%
  select(4,3,7,6,5,1) %>%
  spread(key = percentile, value = values) %>%
  rename(Spw_low = lower,
         Spw_med = median,
         Spw_upp = upper) %>%
  select(-param)
Spawners_ScenA_df <- Spawners_ScenA_df[1:224,]

Rec_and_Spwn_ScenA <- cbind(Recruits_ScenA_df, Spawners_ScenA_df)
Rec_and_Spwn_ScenA <- Rec_and_Spwn_ScenA[,c(1:6,10:12)]
  
Rec_and_Spwn_ScenA$BroodYear <- NA
Rec_and_Spwn_ScenA$BroodYear <- rep(c(1982:2009),times=8)
  

# head(Rec_and_Spwn_ScenA)


```




```{r recruits and spawners dataframe ScenarioB, echo=FALSE}

pop <- c("Lower Mainstem", "Stewart", "Pelly", "White-Donjek", "Middle Mainstem", "Carmacks", "Upper Lakes and Mainstem", "Teslin")

# ScenarioB_posteriors

Recruits_ScenB <- ScenarioB_posteriors[,354:633]
Spawners_ScenB <- ScenarioB_posteriors[,98:353]


R_50 <- stack(lapply(Recruits_ScenB, quantile, prob = 0.5, names = FALSE)) %>%
  mutate(year = rep(c(1:35),times=8),
         population = rep(pop, each = 35),
         param = "recruits",
         percentile = "median")
R_20 <- stack(lapply(Recruits_ScenB, quantile, prob = 0.2, names = FALSE)) %>%
  mutate(year = rep(c(1:35),times=8),
         population = rep(pop, each = 35),
         param = "recruits",
         percentile = "lower")
R_80 <- stack(lapply(Recruits_ScenB, quantile, prob = 0.8, names = FALSE)) %>%
  mutate(year = rep(c(1:35),times=8),
         population = rep(pop, each = 35),
         param = "recruits",
         percentile = "upper")

Recruits_ScenB_df <- rbind(R_50, R_20, R_80) %>%
  mutate(adj_year = as.numeric(as.character(year)) - 7) %>%
  filter(adj_year > 0) %>%
  select(4,3,7,6,5,1) %>%
  spread(key = percentile, value = values) %>%
  rename(Rec_low = lower,
         Rec_med = median,
         Rec_upp = upper) %>%
  select(-param)


S_50 <- stack(lapply(Spawners_ScenB, quantile, prob = 0.5, names = FALSE)) %>%
  mutate(year = rep(c(1:32),times=8),
         population = rep(pop, each = 32),
         param = "spawners",
         percentile = "median")
S_20 <- stack(lapply(Spawners_ScenB, quantile, prob = 0.2, names = FALSE)) %>%
  mutate(year = rep(c(1:32),times=8),
         population = rep(pop, each = 32),
         param = "spawners",
         percentile = "lower")
S_80 <- stack(lapply(Spawners_ScenB, quantile, prob = 0.8, names = FALSE)) %>%
  mutate(year = rep(c(1:32),times=8),
         population = rep(pop, each = 32),
         param = "spawners",
         percentile = "upper")

Spawners_ScenB_df <- rbind(S_50, S_20, S_80) %>%
  mutate(adj_year = as.numeric(as.character(year))) %>%
  select(4,3,7,6,5,1) %>%
  spread(key = percentile, value = values) %>%
  rename(Spw_low = lower,
         Spw_med = median,
         Spw_upp = upper) %>%
  select(-param)
Spawners_ScenB_df <- Spawners_ScenB_df[1:224,]

Rec_and_Spwn_ScenB <- cbind(Recruits_ScenB_df, Spawners_ScenB_df)
Rec_and_Spwn_ScenB <- Rec_and_Spwn_ScenB[,c(1:6,10:12)]

Rec_and_Spwn_ScenB$BroodYear <- NA
Rec_and_Spwn_ScenB$BroodYear <- rep(c(1982:2009),times=8)

```






```{r Spawner recruit relationships ScenarioA, echo=FALSE}

# create vector of abundances for each dataframe
sp_YC <- as.vector(seq(0,20,length.out=100))
sp_YlC <- as.vector(seq(0,20,length.out=100))
sp_Ym <- as.vector(seq(0,40,length.out=100))
sp_YP <- as.vector(seq(0,18,length.out=100))
sp_YS <- as.vector(seq(0,25,length.out=100))
sp_YT <- as.vector(seq(0,25,length.out=100))
sp_Yu <- as.vector(seq(0,30,length.out=100))
sp_YWD <- as.vector(seq(0,9,length.out=100))

# repeat substock abundance vector 100 times for each value of alpha and beta
spw_YC <- rep(c(sp_YC),(100))
spw_YlC <- rep(c(sp_YlC),(100))
spw_Ym <- rep(c(sp_Ym),(100))
spw_YP <- rep(c(sp_YP),(100))
spw_YS <- rep(c(sp_YS),(100))
spw_YT <- rep(c(sp_YT),(100)) 
spw_Yu <- rep(c(sp_Yu),(100))
spw_YWD <- rep(c(sp_YWD),(100))

# combine abundances into single vector
spw_df <- c(spw_YlC, spw_YS, spw_YP, spw_YWD, spw_Ym, spw_YC, spw_Yu, spw_YT)


# add column of abundances to alpha.beta_A dataframe
alpha_A_sample <- alpha.beta_A %>%
  select(1:8) %>%
  sample_n(100, replace=TRUE)

alpha_A_sample2 <- alpha_A_sample[rep(seq_len(nrow(alpha_A_sample)),each=100),] %>%
  mutate(sim = rep(c(1:100), times=100)) %>%
  gather(key = alpha, value = alpha_value, alpha_1:alpha_8) %>%
  mutate(population = rep(pop,each=10000))

beta_A_sample <- alpha.beta_A %>%
  select(9:16) %>%
  sample_n(100, replace=TRUE)

beta_A_sample2 <- beta_A_sample[rep(seq_len(nrow(beta_A_sample)),each=100),] %>%
  mutate(sim = rep(c(1:100), times=100)) %>%
  gather(key = beta, value = beta_value, beta_1:beta_8) %>%
  mutate(population = rep(pop,each=10000))


alpha_beta_ScenA_sample <- cbind(alpha_A_sample2, beta_A_sample2)
alpha_beta_ScenA_sample <- alpha_beta_ScenA_sample[,c(4,1,3,7)]


alpha_beta_ScenA_sample$abund <- NA
alpha_beta_ScenA_sample$abund <- spw_df


abScenA_samp <- alpha_beta_ScenA_sample


# add on 'y' value that has the predicted ricker estimates per abundance value
abScenA_samp$y <- NA
abScenA_samp$y <- abScenA_samp$alpha_value*abScenA_samp$abund*exp(-abScenA_samp$beta_value*abScenA_samp$abund)


# 20 and 80 percentiles
alpha_beta_percentileA <- abScenA_samp %>% 
  group_by(population, abund) %>%
    dplyr::summarise(q_20 = quantile(y, probs=0.20),
                     q_80 = quantile(y, probs=0.8)) 
```



```{r Spawner recruit relationships ScenarioB, echo=FALSE}

# create vector of abundances for each dataframe
sp_YC <- as.vector(seq(0,18,length.out=100))
sp_YlC <- as.vector(seq(0,20,length.out=100))
sp_Ym <- as.vector(seq(0,10,length.out=100))
sp_YP <- as.vector(seq(0,18,length.out=100))
sp_YS <- as.vector(seq(0,20,length.out=100))
sp_YT <- as.vector(seq(0,20,length.out=100))
sp_Yu <- as.vector(seq(0,30,length.out=100))
sp_YWD <- as.vector(seq(0,6,length.out=100))

# repeat substock abundance vector 100 times for each value of alpha and beta
spw_YC <- rep(c(sp_YC),(100))
spw_YlC <- rep(c(sp_YlC),(100))
spw_Ym <- rep(c(sp_Ym),(100))
spw_YP <- rep(c(sp_YP),(100))
spw_YS <- rep(c(sp_YS),(100))
spw_YT <- rep(c(sp_YT),(100)) 
spw_Yu <- rep(c(sp_Yu),(100))
spw_YWD <- rep(c(sp_YWD),(100))

# combine abundances into single vector
spw_df <- c(spw_YlC, spw_YS, spw_YP, spw_YWD, spw_Ym, spw_YC, spw_Yu, spw_YT)


# add column of abundances to alpha.beta_B dataframe
alpha_B_sample <- alpha.beta_B %>%
  select(1:8) %>%
  sample_n(100, replace=TRUE)

alpha_B_sample2 <- alpha_B_sample[rep(seq_len(nrow(alpha_B_sample)),each=100),] %>%
  mutate(sim = rep(c(1:100), times=100)) %>%
  gather(key = alpha, value = alpha_value, alpha_1:alpha_8) %>%
  mutate(population = rep(pop,each=10000))

beta_B_sample <- alpha.beta_B %>%
  select(9:16) %>%
  sample_n(100, replace=TRUE)

beta_B_sample2 <- beta_B_sample[rep(seq_len(nrow(beta_B_sample)),each=100),] %>%
  mutate(sim = rep(c(1:100), times=100)) %>%
  gather(key = beta, value = beta_value, beta_1:beta_8) %>%
  mutate(population = rep(pop,each=10000))


alpha_beta_ScenB_sample <- cbind(alpha_B_sample2, beta_B_sample2)
alpha_beta_ScenB_sample <- alpha_beta_ScenB_sample[,c(4,1,3,7)]


alpha_beta_ScenB_sample$abund <- NA
alpha_beta_ScenB_sample$abund <- spw_df


abScenB_samp <- alpha_beta_ScenB_sample


# add on 'y' value that has the predicted ricker estimates per abundance value
abScenB_samp$y <- NA
abScenB_samp$y <- abScenB_samp$alpha_value*abScenB_samp$abund*exp(-abScenB_samp$beta_value*abScenB_samp$abund)


# 20 and 80 percentiles
alpha_beta_percentileB <- abScenB_samp %>% 
  group_by(population, abund) %>%
    dplyr::summarise(q_20 = quantile(y, probs=0.20),
                     q_80 = quantile(y, probs=0.8)) 
```




```{r Figure 9 Plot Ricker curves ScenarioA, echo=FALSE, fig.dim=c(6,6)}

ggplot() +
  geom_ribbon(data = alpha_beta_percentileA, aes(x = abund, ymin = q_20, ymax = q_80), fill = "grey70", alpha=0.5, linetype=2, colour="gray46") +
  geom_point(data = Rec_and_Spwn_ScenA, aes(x= Spw_med/1000, y = Rec_med/1000, color=as.factor(BroodYear), width=0.9), size=2) +
  geom_errorbar(data = Rec_and_Spwn_ScenA, aes(x= Spw_med/1000, y = Rec_med/1000, 
                                                 ymin = Rec_low/1000, ymax = Rec_upp/1000), colour="grey42", width=0.0, size=0.3) +
  geom_errorbarh(data = Rec_and_Spwn_ScenA, aes(x= Spw_med/1000, y = Rec_med/1000,
                                                xmin = Spw_low/1000, xmax = Spw_upp/1000), colour = "grey42", width=0.0, size = 0.3) + 
  xlab("Spawners (000s)") +
  ylab("Recruits (000s)") +
  facet_wrap(~population, ncol=3, scales = "free") +
  theme_bw() +
  theme(axis.title = element_text(size=12)) +
  theme(axis.text = element_text(size=10))
 # ggsave(file.path(figure_path, paste("Figure_9.ricker_",system_time,".pdf", sep="")),height = 5, width = 7)
 
```




```{r Figure 9 Plot Ricker curves ScenarioB, echo=FALSE, fig.dim=c(6,6)}


ggplot() +
  geom_ribbon(data = alpha_beta_percentileB, aes(x = abund, ymin = q_20, ymax = q_80), fill = "grey70", alpha=0.5, linetype=2, colour="gray46") +
  geom_point(data = Rec_and_Spwn_ScenB, aes(x= Spw_med/1000, y = Rec_med/1000, color=as.factor(BroodYear), width=0.9), size=2) +
  geom_errorbar(data = Rec_and_Spwn_ScenB, aes(x= Spw_med/1000, y = Rec_med/1000, 
                                                 ymin = Rec_low/1000, ymax = Rec_upp/1000), colour="grey42", width=0.0, size=0.3) +
  geom_errorbarh(data = Rec_and_Spwn_ScenB, aes(x= Spw_med/1000, y = Rec_med/1000,
                                                xmin = Spw_low/1000, xmax = Spw_upp/1000), colour = "grey42", width=0.0, size = 0.3) + 
  xlab("Spawners (000s)") +
  ylab("Recruits (000s)") +
  facet_wrap(~population, ncol=3, scales = "free") +
  theme_bw() +
  theme(axis.title = element_text(size=12)) +
  theme(axis.text = element_text(size=10))
 #ggsave(file.path(figure_path, paste("Figure_9.ricker_",system_time,".pdf", sep="")),height = 5, width = 7)

```






```{r Figure 10. Productivity index over time - Scenario A, fig.dim=c(8,8)}

# head(alpha_resid_df_A)

alpha_resid_df_A$population <- factor(alpha_resid_df_A$population, levels = c("Lower Mainstem","Stewart","Pelly",
                                                                              "White-Donjek","Middle Mainstem",
                                                                              "Carmacks","Upper Lakes and Mainstem","Teslin"))

# MyColor <- c("#440154FF", "#482677FF","#39568CFF","#287D8EFF", "#20A387FF", "#29AF7FFF", "#B8DE29FF", "#FDE725FF")

ggplot(alpha_resid_df_A, aes(x=year, y = alpha_med + resid_med), show.legend = F) + #, fill=population
  geom_point(size=1,show.legend = F) + #, aes(colour = factor(population))
  geom_line(show.legend = F) + #, aes(colour = factor(population))
  geom_ribbon(aes(ymin=alpha_lwr + resid_lwr, ymax=alpha_upr + resid_upr), show.legend = F, alpha=0.4) + # , colour=factor(population)
  scale_fill_viridis(option = "viridis", discrete = TRUE) +
  geom_hline(yintercept = 0, lty = "dotted") +
  xlab("Brood year") +
  ylab("Productivity index") +
  scale_x_continuous(breaks=c(1982, 1986, 1990, 1994, 1998, 2002, 2006, 2010, 2014)) +
  scale_y_continuous(limits=c(-6,6), breaks=c(-6,-3,0,3,6)) +
  facet_wrap(~population, nrow=4) +  # ,scales = "free_y"
  theme(legend.position = "none") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust = 1, size=10))
# ggsave(file.path(figure_path, paste("Figure_10.Prod.index_ScenA_",system_time,".pdf", sep="")),height = 5, width = 7)

```





```{r Umsy dataframe ScenarioA and ScenarioB for Figure 11, echo=FALSE}

# Umsy dataframe
Umsy_A <- ScenarioA_posteriors[,17:24] %>%
  sample_n(1000, replace=TRUE) %>%
  gather(key = Umsy, value = value, Umsy_1:Umsy_8) %>%
  mutate(substock = rep(c("Lower Mainstem", "Stewart", "Pelly","White-Donjek","Middle Mainstem", "Carmacks",
                          "Upper Lakes and Mainstem", "Teslin"),each=1000))

Umsy_B <- ScenarioB_posteriors[,17:24] %>%
  sample_n(1000, replace=TRUE) %>%
  gather(key = Umsy, value = value, Umsy_1:Umsy_8) %>%
  mutate(substock = rep(c("Lower Mainstem", "Stewart", "Pelly","White-Donjek","Middle Mainstem", "Carmacks",
                          "Upper Lakes and Mainstem", "Teslin"),each=1000))

```




```{r Figure 11. Usmy posteriors, echo=FALSE, fig.dim=c(6,6)}

# Scenario A
Umsy_A$substock <- factor(Umsy_A$substock, levels = c("Lower Mainstem", "Stewart", "Pelly",
                                                      "White-Donjek","Middle Mainstem", "Carmacks",
                                                      "Upper Lakes and Mainstem", "Teslin"))

ggplot(Umsy_A, aes(x=substock, y=value, fill=substock)) +
  geom_boxplot(outlier.shape = NA, size=1.25) +
  #coord_flip() +
  xlab("Population") +
  ylab("U.msy posteriors") +
  scale_y_continuous(limits=c(0,1)) +
  scale_fill_viridis(option = "viridis", discrete = TRUE) +
  theme_classic() +
  theme(axis.text.x = element_text(angle=45, hjust=1, size=10))+
  theme(axis.text.y = element_text(size=10)) +
  theme(axis.title = element_text(size=12)) +
  theme(legend.position="none")
# ggsave(file.path(figure_path, paste("Figure_11.Umsy_ScenA_",system_time,".pdf", sep="")),height = 5, width = 7)




# Scenario B
Umsy_B$substock <- factor(Umsy_B$substock, levels = c("Lower Mainstem", "Stewart", "Pelly",
                                                      "White-Donjek","Middle Mainstem", "Carmacks",
                                                      "Upper Lakes and Mainstem", "Teslin"))

ggplot(Umsy_B, aes(x=substock, y=value, fill=substock)) +
  geom_boxplot(outlier.shape = NA, size=1.25) +
  #coord_flip() +
  xlab("Population") +
  ylab("U.msy posteriors") +
  scale_y_continuous(limits=c(0,1)) +
  #scale_fill_manual(values = MyColour) +
  scale_fill_viridis(option = "viridis", discrete = TRUE) +
  theme_classic() +
  theme(axis.text.x = element_text(angle=45, hjust=1, size=10))+
  theme(axis.text.y = element_text(size=10)) +
  theme(axis.title = element_text(size=12)) +
  theme(legend.position="none")
# ggsave(file.path(figure_path, paste("Figure_11.Umsy_ScenB_",system_time,".pdf", sep="")),height = 5, width = 7)


```







```{r Figure 13 tradeoff plots prepare dataframe, echo=FALSE, message=FALSE}

U <- seq(0,1,0.01)

pop <- c("Lower Mainstem", "Stewart", "Pelly", "White-Donjek", "Middle Mainstem", "Carmacks", "Upper Lakes and Mainstem", "Teslin")

alpha <- alpha.beta_A %>%
  select(1:8) %>%
  gather(key = alpha, value = alpha_value, alpha_1:alpha_8) %>%
  mutate(population = rep(pop,each=10000)) %>%
  select(-alpha)

beta <- alpha.beta_A %>%
  select(9:16) %>%
  gather(key = beta, value = beta_value, beta_1:beta_8) %>%
  mutate(population = rep(pop,each=10000)) %>%
  select(-beta)


alpha_beta <- data.frame(alpha$population, alpha$alpha_value, beta$beta_value) %>%
  rename(population = alpha.population,
         alpha = alpha.alpha_value,
         beta = beta.beta_value)


short_posteriors <- plyr::ddply(alpha_beta,c("population"), function(x) {
	alphas <- x$alpha[1:10000]
	betas <- x$beta[1:10000]
	data.frame(alphas,betas)
    })

wide.posteriors <- array(NA,dim=c(10000,8,2), dimnames=list(NULL, unique(short_posteriors$population), c("alphas","betas")))

for(i in unique(short_posteriors$population)) {
	xx <- subset(short_posteriors,population==i)
	wide.posteriors[,i,1] <- xx[,2]
	wide.posteriors[,i,2] <- xx[,3]
}

alphas <- 8
betas <- 8





# estimate equilibrium yield profile and corresponding risk
t3 <- array(NA,dim=c(length(U),4,10000))

for(w in 1:10000) {
	draw <- sample(10000,1)
	aa<-seq(1, alphas,1)
	bb <- seq(1, alphas,1)
	for (k in 1: alphas) {
	  aa[k] <- log(wide.posteriors[draw,k,1])   # 
	  bb[k] <- wide.posteriors[draw,k,2] }
	for (i in 1:length(U)) {
  		t1 <- matrix(nrow=length(aa),ncol=4)
  		for (j in 1:length(aa)) {
   			 t1[j,] <- SC.eq(U[i],aa[j],bb[j])
   		 }
  		t3[i,,w] <- apply(t1,2,sum)
  		t3[i,3:4,w] <- t3[i,3:4,w]/length(aa)
  	}
}

t3.median <- apply(t3,1:2,quantile,probs=c(0.5),na.rm=T)
t3.upper <-apply(t3,1:2,quantile,probs=c(0.9),na.rm=T)
t3.lower <- apply(t3,1:2,quantile,probs=c(0.1),na.rm=T)
t3.median[101,2]<-0
t3.upper[101,2]<-0
t3.lower[101,2]<-0

yyy <- as.numeric(t3.median[,3])
xxx <- as.numeric((U*100))
xx <- loess(yyy~xxx)
over.med <- predict(xx)
over.med[over.med <0] =0 
over.med[over.med >1] =1 
over.med[1:8]=0

yyy <- as.numeric(t3.upper[,3])
xxx <- as.numeric((U*100))
xx <- loess(yyy~xxx)
over.up <- predict(xx)
over.up[over.up <0] =0 
over.up[over.up >1] =1 
over.up[97:101] =1 
over.up[1:8]=0

yyy <- as.numeric(t3.lower[,3])
xxx <- as.numeric((U*100))
xx <- loess(yyy~xxx)
over.low <- predict(xx)
over.low[over.low <0] =0 
over.low[over.low >1] =1 
over.low[97:101] =1 
over.low[1:8]=0

yyy <- as.numeric(t3.median[,4])
xxx <- as.numeric((U*100))
xx <- loess(yyy~xxx)
ext.med <- predict(xx)
ext.med[ext.med <0] =0 
ext.med[ext.med >1] =1 
#ext.med[1:8]=0

yyy <- as.numeric(t3.upper[,4])
xxx <- as.numeric((U*100))
xx <- loess(yyy~xxx)
ext.up <- predict(xx)
ext.up[ext.up <0] =0 
ext.up[ext.up >1] =1 
#ext.up[97:101] =1 
#ext.up[1:8]=0

yyy <- as.numeric(t3.lower[,4])
xxx <- as.numeric((U*100))
xx <- loess(yyy~xxx)
ext.low <- predict(xx)
ext.low[ext.low <0] =0 
ext.low[ext.low >1] =1 
#ext.low[97:101] =1 
#ext.low[1:8]=0



# create dataframe
t3.upper2 <- as.data.frame(t3.upper)
t3.upper2$strata <- rep(c("upper"),(101))

t3.lower2 <- as.data.frame(t3.lower)
t3.lower2$strata <- rep(c("lower"),(101))

t3.median2 <- as.data.frame(t3.median)
t3.median2$strata <- rep(c("median"),(101))


t3.2 <- cbind(t3.upper2, t3.lower2, t3.median2)

names(t3.2) <- c("upp_V1","upp_V2","upp_V3","upp_V4","up_strata",
                 "low_V1","low_V2","low_V3","low_V4","low_strata",
                 "med_V1","med_V2","med_V3","med_V4","med_strata")

t3.2$U <- U

t3.2$over.med <- over.med
t3.2$over.up <- over.up
t3.2$over.low <- over.low

t3.2$ext.med <- ext.med
t3.2$ext <- ext.up
t3.2$ext.low <- ext.low

t3.3 <- t3.2 %>%
  select(-5,-10,-15)



```





```{r Figure 13 tradeoff plots Scenario A, echo=FALSE}
# head(t3.3)

# panel a: overfished
ggplot(t3.3, aes(x=U*100, y=med_V2)) +
  ggtitle("Overfished") +
  geom_line(linetype = "solid", size=1.25, color="blue") +
  geom_ribbon(aes(ymin=low_V2, ymax=upp_V2), alpha=0.2, color="blue", lty="dashed", fill = "blue") +
  geom_line(aes(x=U*100,y=over.med*100), color="red", size=1.25) +
  geom_ribbon(aes(ymin=over.low*100, ymax=over.up*100), alpha=0.2, color="red", lty="dashed", fill= "red") +
  scale_y_continuous(limits = c(0,100), breaks=c(0,20,40,60,80,100)) +
  scale_y_continuous(sec.axis = sec_axis(~./300, name = "Stocks overfished or exirpated (%)")) +
  scale_x_continuous(limits = c(0,100), breaks=c(0,20,40,60,80,100)) +
  ylab("Harvest (000s)") +
  xlab("Harvest rate (%)") +
  theme_classic() +
  theme(axis.text.y = element_text(color="blue", size=12)) +
  theme(axis.text.y.right = element_text(color="red", size=12)) +
  theme(axis.title.y = element_text(color="blue", size=12)) +
  theme(axis.title.y.right = element_text(color="red", size=12)) +
  theme(axis.text.x = element_text(size=12)) +
  theme(axis.title.x = element_text(size=12)) +
  theme(plot.title = element_text(hjust = 0.5, size=12)) +
  annotate("text", x=5, y=95,label="A", size=8)
ggsave(file.path(figure_path, paste("Figure_13.tradeoff.overfish_ScenA_",system_time,".pdf", sep="")),height = 5, width = 7)


# panel b: extirpated
ggplot(t3.3, aes(x=U*100, y=med_V2)) +
  ggtitle("Extirpated") +
  geom_line(linetype = "solid", size=1.25, color="blue") +
  geom_ribbon(aes(ymin=low_V2, ymax=upp_V2), alpha=0.2, color="blue", lty="dashed", fill = "blue") +
  geom_line(aes(x=U*100,y=ext.med*100), color="red", size=1.25) +
  geom_ribbon(aes(ymin=ext.low*100, ymax=ext.up*100), alpha=0.2, color="red", lty="dashed", fill= "red") +
  scale_y_continuous(limits = c(0,100), breaks=c(0,20,40,60,80,100)) +
  scale_x_continuous(limits = c(0,100), breaks=c(0,20,40,60,80,100)) +
  ylab("Harvest (000s)") +
  xlab("Harvest rate (%)") +
  theme_classic() +
  theme(axis.text.y = element_text(color="blue", size=12)) +
  theme(axis.text.y.right = element_text(color="red", size=12)) +
  theme(axis.title.y = element_text(color="blue", size=12)) +
  theme(axis.title.y.right = element_text(color="red", size=12)) +
  theme(axis.text.x = element_text(size=12)) +
  theme(axis.title.x = element_text(size=12)) +
  theme(plot.title = element_text(hjust = 0.5, size=12)) +
  annotate("text", x=5, y=95,label="B", size=8)
ggsave(file.path(figure_path, paste("Figure_13.tradeoff.extirpate_ScenA_",system_time,".pdf", sep="")),height = 5, width = 7)

```









